<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>r-exercise-hypothesistesting.utf8.md</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="r-exercise-hypothesistesting.utf8.md" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="r-exercise-hypothesistesting.utf8.md" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">


      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:title:end-->
<!--bookdown:title:start-->
<p>#<a href="#r-ex-hyp">Hypothesis Testing in R</a></p>
<p>#1. Hypothesis tests</p>
<p>We are going to use an example of an experiment where we randomly assign people to receive a free water purification device. We are interested in knowing if this treatment (i.e., the sanitation device) reduces the number of days a person is sick in a year.</p>
<p>The first thing we need is to create the data. For the purpose of the following exercise, we will use complete randomization.</p>
<ul>
<li>We carried out the experiments in 10 municipalities</li>
<li>In each municipality, we take a random sample of 60 people</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())
<span class="kw">library</span>(estimatr) <span class="co"># robust regression</span>

<span class="co"># 1. Make a dataset ----------------------------------------------------------</span>

<span class="co"># We are going to look at the example of an experiment where people are randomly</span>
<span class="co"># assigned to receive a free water sanitation device. We are interested in</span>
<span class="co"># whether the treatment reduces the number of days in the year that the person </span>
<span class="co"># was sick. We will look at different ways the treatment can be assigned.</span>

<span class="co"># We conduct a survey in 10 villages</span>

(villages &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;vill 01&quot;</span>,<span class="st">&quot;vill 02&quot;</span>,<span class="st">&quot;vill 03&quot;</span>,<span class="st">&quot;vill 04&quot;</span>,<span class="st">&quot;vill 05&quot;</span>,
              <span class="st">&quot;vill 06&quot;</span>,<span class="st">&quot;vill 07&quot;</span>,<span class="st">&quot;vill 08&quot;</span>,<span class="st">&quot;vill 09&quot;</span>,<span class="st">&quot;vill 10&quot;</span>))</code></pre>
<pre><code>##  [1] &quot;vill 01&quot; &quot;vill 02&quot; &quot;vill 03&quot; &quot;vill 04&quot; &quot;vill 05&quot; &quot;vill 06&quot; &quot;vill 07&quot;
##  [8] &quot;vill 08&quot; &quot;vill 09&quot; &quot;vill 10&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We randomly sample 60 people in each village</span>

(samples &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>,
             <span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>,<span class="dv">60</span>))</code></pre>
<pre><code>##  [1] 60 60 60 60 60 60 60 60 60 60</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># So our total sample size, N, is 10 x 60, or the sum of our samples</span>

(N &lt;-<span class="st"> </span><span class="kw">sum</span>(samples))</code></pre>
<pre><code>## [1] 600</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Generate a unique number for each person in our total sample</span>

(ID &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>N)</code></pre>
<pre><code>##   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17
##  [18]  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34
##  [35]  35  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51
##  [52]  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68
##  [69]  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85
##  [86]  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 101 102
## [103] 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119
## [120] 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136
## [137] 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153
## [154] 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170
## [171] 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187
## [188] 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204
## [205] 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221
## [222] 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238
## [239] 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255
## [256] 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272
## [273] 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289
## [290] 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306
## [307] 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323
## [324] 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340
## [341] 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357
## [358] 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374
## [375] 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391
## [392] 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408
## [409] 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425
## [426] 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442
## [443] 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459
## [460] 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476
## [477] 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493
## [494] 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510
## [511] 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527
## [528] 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544
## [545] 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561
## [562] 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578
## [579] 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595
## [596] 596 597 598 599 600</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now let&#39;s generate a variable telling us what village each person came </span>
<span class="co"># from:</span>

village &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dt">x =</span> villages,    <span class="co"># Repeat the names of the villages</span>
               <span class="dt">times =</span> samples) <span class="co"># 60 times for each village</span>

<span class="co"># Let&#39;s look at the ID and village for each person:</span>

<span class="kw">head</span>(<span class="kw">cbind</span>(ID,village),<span class="dv">30</span>)</code></pre>
<pre><code>##       ID   village  
##  [1,] &quot;1&quot;  &quot;vill 01&quot;
##  [2,] &quot;2&quot;  &quot;vill 01&quot;
##  [3,] &quot;3&quot;  &quot;vill 01&quot;
##  [4,] &quot;4&quot;  &quot;vill 01&quot;
##  [5,] &quot;5&quot;  &quot;vill 01&quot;
##  [6,] &quot;6&quot;  &quot;vill 01&quot;
##  [7,] &quot;7&quot;  &quot;vill 01&quot;
##  [8,] &quot;8&quot;  &quot;vill 01&quot;
##  [9,] &quot;9&quot;  &quot;vill 01&quot;
## [10,] &quot;10&quot; &quot;vill 01&quot;
## [11,] &quot;11&quot; &quot;vill 01&quot;
## [12,] &quot;12&quot; &quot;vill 01&quot;
## [13,] &quot;13&quot; &quot;vill 01&quot;
## [14,] &quot;14&quot; &quot;vill 01&quot;
## [15,] &quot;15&quot; &quot;vill 01&quot;
## [16,] &quot;16&quot; &quot;vill 01&quot;
## [17,] &quot;17&quot; &quot;vill 01&quot;
## [18,] &quot;18&quot; &quot;vill 01&quot;
## [19,] &quot;19&quot; &quot;vill 01&quot;
## [20,] &quot;20&quot; &quot;vill 01&quot;
## [21,] &quot;21&quot; &quot;vill 01&quot;
## [22,] &quot;22&quot; &quot;vill 01&quot;
## [23,] &quot;23&quot; &quot;vill 01&quot;
## [24,] &quot;24&quot; &quot;vill 01&quot;
## [25,] &quot;25&quot; &quot;vill 01&quot;
## [26,] &quot;26&quot; &quot;vill 01&quot;
## [27,] &quot;27&quot; &quot;vill 01&quot;
## [28,] &quot;28&quot; &quot;vill 01&quot;
## [29,] &quot;29&quot; &quot;vill 01&quot;
## [30,] &quot;30&quot; &quot;vill 01&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now generate a variable that is 1 if the person is female, and 0 if male</span>

(female &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">30</span>),<span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">30</span>)),<span class="dv">10</span>)) <span class="co"># 30 females in each village sample</span></code></pre>
<pre><code>##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0
##  [36] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1
##  [71] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [106] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [141] 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [176] 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [211] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1
## [246] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0
## [281] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [316] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [351] 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [386] 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [421] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0
## [456] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1
## [491] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [526] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [561] 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [596] 0 0 0 0 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Let&#39;s now generate how many days in the year people would have been sick for</span>
<span class="co"># if they did not receive the water sanitation device (negative binomial dist.). </span>

(days.sick.no.device &lt;-<span class="st"> </span><span class="kw">rnbinom</span>(<span class="dt">n =</span> N, <span class="dt">mu =</span> <span class="dv">10</span>,<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="dv">7</span>)</code></pre>
<pre><code>##   [1]  26  17  12  11  51  30  10  11  17  11   7  18  12  25  10   8  11
##  [18]  11  12  23  29   8  10   9  20   8  25  13  15  12  17  17   9  10
##  [35]   9  41  11  16  30  13  29  32  15  13  14  14  26   7  14  14  15
##  [52]  13  20  29   9  11  12  27  28  13  10  29  12  13  10  19  10  11
##  [69]  13   7  13  39  11  17  16   7  25   7  25  23  11  14  11  10  23
##  [86]  15  32  24  10  20  14  35  13  31   7  21  31   8  13   7  31  25
## [103]  22  24  11  36  11  17  16  24  11   9  11  39   7  20  16  10  18
## [120]   9   7  10  21  71   9  16   7  10  38  28  13   9  11  23  52  32
## [137]   8  19  34   9  14  16   8  21  25  25   9  11  12  10   7  23  13
## [154]  13  34  19  21  23  12   8  12   9  22  24  16   7  44  14   9  16
## [171]  14  11  16  37  15   8  29  23   9  26   8  11  15  13  15  11  11
## [188]  41  11  27  29  11  13  10  15  19  11  13  25  44  23  15  10  44
## [205]  12   7   9  11   9  29   8  12  12  15  10  10   8   8  42   9   8
## [222]   8  10  14  25  12  23  23  20  21  16  18   7   9  11  16  14  10
## [239]  23  11  10  25  34   7  19  10   9  16  29  12   7   9  24   8   7
## [256]  16  13  13   9   7  11  23  10   7  10  35  22   9  31  11   7   8
## [273]   8   8  25   8  22  11   8  13  25  32  19  20  24  11  10   7  10
## [290]  16  10  45  28  19  31   8  10  17  25  12  11  25   7   9  16  22
## [307]  21  29  18  39  14  17  28  10   9  57   7  14  14   8  12  10  19
## [324]   7  17  48  18   9   7   9   8   8   7  29  13  20  12  11  22  13
## [341]  24  10  17  15  53  50  16  46  30  11  47  37   8   7   8  13  10
## [358]  35   7  11   7  21  16  17  15  17  12  12  15  21  23   9  12  16
## [375]  14   7  23  17  34  19  18  12  10   9  11  11   7   8   8  20   7
## [392]   9   8   8  29  24  17  12  21  16  14  33  15  32  12   8  11  29
## [409]  20  20  89  12  56  22  16  21   7  20   8   7   9  15  10  15  18
## [426]  12  12  30  18   8   7   7   9  20  28   7  12  20   7  21   7   7
## [443]  11  13  24  30  11  37  11  10  12  18  12  26  26   9   8  21   9
## [460]  29  10  15  31  49  17  13  17   8  27  12  32   9  31  10  13   9
## [477]   9  11  14  16   8   7  61  19  11  11  26  48  13  20  13  24  13
## [494]  16  12  35  10  10  46   9  11  22   9  15  10  34  11  16   9   8
## [511]  14   8  27   9  11  10  14  12   7  10  30  15  13  20   9  35  16
## [528]  12  24  16   8  13  12  10   8  12  16  26  23   9  26  11  16  10
## [545]  12  15  14   9  24  15  13   9  22   9  10  52  10   8  11   8  23
## [562]   8   9  12  14  39   7   9  16 112  15  19  29   7   7  13  20  30
## [579]   8   7  22  10  10   7  26  16  33   7  25  13  17  27   8  16  15
## [596]  11   9  17  14  11</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Let&#39;s also imagine that some villages are hit by </span>
<span class="co"># an outbreak of a virus that means people in those villages were all sick </span>
<span class="co"># 5 times more during the year under study.</span>

<span class="co"># Define the effect of having an outbreak in your village:</span>

(outbreak.effect &lt;-<span class="st"> </span><span class="dv">5</span>)    <span class="co"># the effect is 5 days</span></code></pre>
<pre><code>## [1] 5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Let&#39;s randomly choose 3 of the 10 villages that were hit by the virus</span>

(outbreak.villages &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dt">x =</span> villages,<span class="dt">size =</span> <span class="dv">3</span>))</code></pre>
<pre><code>## [1] &quot;vill 01&quot; &quot;vill 03&quot; &quot;vill 09&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add the effect to the people in those villages using an if / else function, </span>
<span class="co"># this is the &#39;control&#39; potential outcome for the people in our experiment</span>

(Y0 &lt;-<span class="st"> </span>
<span class="st">     </span><span class="kw">ifelse</span>(
          <span class="co"># Is the person&#39;s village in the outbreak list?</span>
          <span class="dt">test =</span> village <span class="op">%in%</span><span class="st"> </span>outbreak.villages,    
          <span class="co"># If yes, then give that person the outbreak effect</span>
          <span class="dt">yes =</span> days.sick.no.device <span class="op">+</span><span class="st"> </span>outbreak.effect,
          <span class="co"># If no, then don&#39;t increase the number of days they were sick</span>
          <span class="dt">no =</span> days.sick.no.device <span class="op">+</span><span class="st"> </span><span class="dv">0</span>
     ))</code></pre>
<pre><code>##   [1]  31  22  17  16  56  35  15  16  22  16  12  23  17  30  15  13  16
##  [18]  16  17  28  34  13  15  14  25  13  30  18  20  17  22  22  14  15
##  [35]  14  46  16  21  35  18  34  37  20  18  19  19  31  12  19  19  20
##  [52]  18  25  34  14  16  17  32  33  18  10  29  12  13  10  19  10  11
##  [69]  13   7  13  39  11  17  16   7  25   7  25  23  11  14  11  10  23
##  [86]  15  32  24  10  20  14  35  13  31   7  21  31   8  13   7  31  25
## [103]  22  24  11  36  11  17  16  24  11   9  11  39   7  20  16  10  18
## [120]   9  12  15  26  76  14  21  12  15  43  33  18  14  16  28  57  37
## [137]  13  24  39  14  19  21  13  26  30  30  14  16  17  15  12  28  18
## [154]  18  39  24  26  28  17  13  17  14  27  29  21  12  49  19  14  21
## [171]  19  16  21  42  20  13  34  28  14  31   8  11  15  13  15  11  11
## [188]  41  11  27  29  11  13  10  15  19  11  13  25  44  23  15  10  44
## [205]  12   7   9  11   9  29   8  12  12  15  10  10   8   8  42   9   8
## [222]   8  10  14  25  12  23  23  20  21  16  18   7   9  11  16  14  10
## [239]  23  11  10  25  34   7  19  10   9  16  29  12   7   9  24   8   7
## [256]  16  13  13   9   7  11  23  10   7  10  35  22   9  31  11   7   8
## [273]   8   8  25   8  22  11   8  13  25  32  19  20  24  11  10   7  10
## [290]  16  10  45  28  19  31   8  10  17  25  12  11  25   7   9  16  22
## [307]  21  29  18  39  14  17  28  10   9  57   7  14  14   8  12  10  19
## [324]   7  17  48  18   9   7   9   8   8   7  29  13  20  12  11  22  13
## [341]  24  10  17  15  53  50  16  46  30  11  47  37   8   7   8  13  10
## [358]  35   7  11   7  21  16  17  15  17  12  12  15  21  23   9  12  16
## [375]  14   7  23  17  34  19  18  12  10   9  11  11   7   8   8  20   7
## [392]   9   8   8  29  24  17  12  21  16  14  33  15  32  12   8  11  29
## [409]  20  20  89  12  56  22  16  21   7  20   8   7   9  15  10  15  18
## [426]  12  12  30  18   8   7   7   9  20  28   7  12  20   7  21   7   7
## [443]  11  13  24  30  11  37  11  10  12  18  12  26  26   9   8  21   9
## [460]  29  10  15  31  49  17  13  17   8  27  12  32   9  31  10  13   9
## [477]   9  11  14  16  13  12  66  24  16  16  31  53  18  25  18  29  18
## [494]  21  17  40  15  15  51  14  16  27  14  20  15  39  16  21  14  13
## [511]  19  13  32  14  16  15  19  17  12  15  35  20  18  25  14  40  21
## [528]  17  29  21  13  18  17  15  13  17  21  31  28  14  26  11  16  10
## [545]  12  15  14   9  24  15  13   9  22   9  10  52  10   8  11   8  23
## [562]   8   9  12  14  39   7   9  16 112  15  19  29   7   7  13  20  30
## [579]   8   7  22  10  10   7  26  16  33   7  25  13  17  27   8  16  15
## [596]  11   9  17  14  11</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now let&#39;s generate the treatment effects, but let&#39;s imagine that the treatment</span>
<span class="co"># is less effective for men on average than it is for women.</span>

<span class="co"># If a male receives the treatment, he gets sick 2 times fewer in a year</span>

(effect.male &lt;-<span class="st"> </span><span class="dv">-2</span>) </code></pre>
<pre><code>## [1] -2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># If a female receives the treatment, she gets sick 7 times fewer in a year</span>

(effect.female &lt;-<span class="st"> </span><span class="dv">-7</span>)</code></pre>
<pre><code>## [1] -7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can use the ifelse() function again </span>

(Y1 &lt;-<span class="st"> </span>
<span class="st">     </span><span class="kw">ifelse</span>(
          <span class="co"># Is the person a female?</span>
          <span class="dt">test =</span> female <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,
          <span class="co"># If yes, then give that person the female effect</span>
          <span class="dt">yes =</span> Y0 <span class="op">+</span><span class="st"> </span>effect.female,
          <span class="co"># If no, then give that person the male effect</span>
          <span class="dt">no =</span> Y0 <span class="op">+</span><span class="st"> </span>effect.male
     ))</code></pre>
<pre><code>##   [1]  24  15  10   9  49  28   8   9  15   9   5  16  10  23   8   6   9
##  [18]   9  10  21  27   6   8   7  18   6  23  11  13  10  20  20  12  13
##  [35]  12  44  14  19  33  16  32  35  18  16  17  17  29  10  17  17  18
##  [52]  16  23  32  12  14  15  30  31  16   3  22   5   6   3  12   3   4
##  [69]   6   0   6  32   4  10   9   0  18   0  18  16   4   7   4   3  16
##  [86]   8  25  17   3  13  12  33  11  29   5  19  29   6  11   5  29  23
## [103]  20  22   9  34   9  15  14  22   9   7   9  37   5  18  14   8  16
## [120]   7   5   8  19  69   7  14   5   8  36  26  11   7   9  21  50  30
## [137]   6  17  32   7  12  14   6  19  23  23   7   9  10   8  10  26  16
## [154]  16  37  22  24  26  15  11  15  12  25  27  19  10  47  17  12  19
## [171]  17  14  19  40  18  11  32  26  12  29   1   4   8   6   8   4   4
## [188]  34   4  20  22   4   6   3   8  12   4   6  18  37  16   8   3  37
## [205]   5   0   2   4   2  22   6  10  10  13   8   8   6   6  40   7   6
## [222]   6   8  12  23  10  21  21  18  19  14  16   5   7   9  14  12   8
## [239]  21   9   3  18  27   0  12   3   2   9  22   5   0   2  17   1   0
## [256]   9   6   6   2   0   4  16   3   0   3  28  15   2  24   4   5   6
## [273]   6   6  23   6  20   9   6  11  23  30  17  18  22   9   8   5   8
## [290]  14   8  43  26  17  29   6   8  15  23  10   4  18   0   2   9  15
## [307]  14  22  11  32   7  10  21   3   2  50   0   7   7   1   5   3  12
## [324]   0  10  41  11   2   0   2   6   6   5  27  11  18  10   9  20  11
## [341]  22   8  15  13  51  48  14  44  28   9  45  35   6   5   6  11   8
## [358]  33   5   9   0  14   9  10   8  10   5   5   8  14  16   2   5   9
## [375]   7   0  16  10  27  12  11   5   3   2   4   4   0   1   1  13   5
## [392]   7   6   6  27  22  15  10  19  14  12  31  13  30  10   6   9  27
## [409]  18  18  87  10  54  20  14  19   5  18   6   5   2   8   3   8  11
## [426]   5   5  23  11   1   0   0   2  13  21   0   5  13   0  14   0   0
## [443]   4   6  17  23   4  30   4   3  10  16  10  24  24   7   6  19   7
## [460]  27   8  13  29  47  15  11  15   6  25  10  30   7  29   8  11   7
## [477]   7   9  12  14   6   5  59  17   9   9  24  46  11  18  11  22  11
## [494]  14  10  33   8   8  44   7   9  20   7  13   8  32   9  14   7   6
## [511]  17  11  30  12  14  13  17  15  10  13  33  18  16  23  12  38  19
## [528]  15  27  19  11  16  15  13  11  15  19  29  26  12  19   4   9   3
## [545]   5   8   7   2  17   8   6   2  15   2   3  45   3   1   4   1  16
## [562]   1   2   5   7  32   0   2   9 105  13  17  27   5   5  11  18  28
## [579]   6   5  20   8   8   5  24  14  31   5  23  11  15  25   6  14  13
## [596]   9   7  15  12   9</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now we have our experimental dataset: </span>

data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
     <span class="dt">ID =</span> ID,
     <span class="dt">village =</span> village,
     <span class="dt">female =</span> female,
     <span class="dt">Y0 =</span> Y0,
     <span class="dt">Y1 =</span> Y1
)

<span class="kw">head</span>(data)</code></pre>
<pre><code>##   ID village female Y0 Y1
## 1  1 vill 01      1 31 24
## 2  2 vill 01      1 22 15
## 3  3 vill 01      1 17 10
## 4  4 vill 01      1 16  9
## 5  5 vill 01      1 56 49
## 6  6 vill 01      1 35 28</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 2. Complete Random Assignment ----------------------------------------------</span>

<span class="co"># Imagine we only had 200 devices to assign to people. In this case, simple </span>
<span class="co"># random assignment would be inappropriate, as we are likely to assign too many </span>
<span class="co"># (or too few) people to treatment. </span>

<span class="co"># Complete random assignment lets us determine exactly how many people we want</span>
<span class="co"># to assign to treatment before we run the randomization.</span>

<span class="co"># Generate a list of 200 1&#39;s and 400 0&#39;s</span>

(complete.ra &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">200</span>),
                 <span class="kw">rep</span>(<span class="dv">0</span>,N<span class="dv">-200</span>)))</code></pre>
<pre><code>##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [36] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [71] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [106] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [141] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [176] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0
## [211] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [246] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [281] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [316] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [351] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [386] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [421] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [456] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [491] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [526] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [561] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [596] 0 0 0 0 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And then scramble it randomly using sample()</span>
<span class="kw">set.seed</span>(<span class="dv">12345</span>)

<span class="co"># Notice that the default is sampling without replacement</span>
(complete.ra &lt;-<span class="st"> </span><span class="kw">sample</span>(complete.ra)) </code></pre>
<pre><code>##   [1] 1 1 0 0 0 0 1 1 1 0 1 0 0 0 1 0 1 1 0 1 0 0 0 0 0 1 1 1 0 0 1 0 1 0 1
##  [36] 0 0 1 0 0 0 0 1 0 0 1 0 1 1 0 0 0 0 0 1 1 0 0 0 0 0 0 1 1 0 0 0 0 0 0
##  [71] 0 0 0 0 0 1 0 1 0 1 0 1 0 0 1 1 0 0 1 0 0 1 0 0 0 1 1 0 0 0 0 1 0 0 1
## [106] 0 1 0 1 1 1 0 1 1 0 0 0 0 1 1 0 0 1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1
## [141] 1 0 0 1 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 1 1 0 1 0 0 1 0 0 0 0 0 1 0 0
## [176] 0 0 0 0 1 0 0 1 0 1 0 0 1 0 0 1 0 0 0 0 0 0 1 0 1 0 0 0 0 1 0 0 1 1 0
## [211] 0 0 0 1 1 1 0 0 0 1 0 1 0 1 1 0 1 0 1 0 1 1 0 0 0 0 0 1 0 0 0 1 0 0 0
## [246] 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 1 1 1 0 1 0 0 0 0 0 1 0 0 0 1 0 0 1 0 0
## [281] 1 0 1 0 0 1 0 0 0 0 1 0 1 1 0 0 0 1 0 0 0 0 0 1 0 1 1 0 0 0 0 0 0 1 0
## [316] 1 0 1 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 1 1 0 0 1 0 0 0 1 1 0
## [351] 0 0 0 0 0 0 1 0 0 1 1 0 0 1 0 1 1 1 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 1
## [386] 0 1 0 1 0 0 1 0 1 0 0 0 0 0 1 0 0 1 0 0 0 1 0 0 0 1 1 0 0 0 0 1 0 0 0
## [421] 1 0 0 1 1 0 0 1 0 0 0 1 1 1 1 0 1 0 1 1 0 0 1 1 0 0 1 0 0 1 0 1 1 0 0
## [456] 0 1 0 1 0 1 0 1 0 0 1 0 0 0 0 0 1 0 0 0 0 1 1 1 0 0 0 1 1 1 0 1 0 1 0
## [491] 1 0 0 0 1 1 0 1 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 1 1 0 1 0 1 0 0 1 0
## [526] 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 1 1 0 0 0 0 1 1 0 0 0 0 0 1 1 0 0 0 0 1
## [561] 1 0 1 0 0 0 1 0 1 0 0 1 0 1 0 0 0 0 1 0 0 0 0 1 0 1 0 0 0 0 0 0 1 0 1
## [596] 0 0 0 1 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(complete.ra)</code></pre>
<pre><code>## [1] 200</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Let&#39;s add it to the data</span>

data<span class="op">$</span>complete.ra &lt;-<span class="st"> </span>complete.ra

<span class="kw">head</span>(data)</code></pre>
<pre><code>##   ID village female Y0 Y1 complete.ra
## 1  1 vill 01      1 31 24           1
## 2  2 vill 01      1 22 15           1
## 3  3 vill 01      1 17 10           0
## 4  4 vill 01      1 16  9           0
## 5  5 vill 01      1 56 49           0
## 6  6 vill 01      1 35 28           0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And let&#39;s generate the outcome we would have observed under this assignment</span>

data<span class="op">$</span>complete.obs &lt;-<span class="st"> </span><span class="kw">with</span>(data,Y1<span class="op">*</span>complete.ra<span class="op">+</span>Y0<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>complete.ra))

<span class="kw">head</span>(data)</code></pre>
<pre><code>##   ID village female Y0 Y1 complete.ra complete.obs
## 1  1 vill 01      1 31 24           1           24
## 2  2 vill 01      1 22 15           1           15
## 3  3 vill 01      1 17 10           0           17
## 4  4 vill 01      1 16  9           0           16
## 5  5 vill 01      1 56 49           0           56
## 6  6 vill 01      1 35 28           0           35</code></pre>
<p>Now, we would like to explore whether the supply of devices reduces the average number of days in the year in which the person was ill. To do this, we want to test whether the average number of days is higher for the control group than for the treatment group.</p>
<p>Using the “complete randomization” vector, we first need to calculate the average in each group for our experiment. Now, we need to reveal the observed data and then calculate the difference of means:</p>
<pre class="sourceCode r"><code class="sourceCode r">av.treat &lt;-<span class="st"> </span><span class="kw">mean</span>(data<span class="op">$</span>complete.obs[data<span class="op">$</span>complete.ra <span class="op">==</span><span class="st"> </span><span class="dv">1</span>])
av.control &lt;-<span class="st"> </span><span class="kw">mean</span>(data<span class="op">$</span>complete.obs[data<span class="op">$</span>complete.ra <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])
diff.mean &lt;-<span class="st"> </span>av.treat <span class="op">-</span><span class="st"> </span>av.control
diff.mean</code></pre>
<pre><code>## [1] -6.123</code></pre>
<blockquote>
<p>What is a good test?</p>
</blockquote>
<p>Note that if our treatment had no effect, then both averages should be the same. Therefore, our null hypothesis ($ H_0 $) must be that the difference between these two means is equal to zero.</p>
<p>** NOTE: ** In particular, we want to know what is the probability of obtaining a difference of means as extreme as that observed in the data (in absolute terms) if the null hypothesis is true, the * p * -value.</p>
<p>We will do this in two ways: using a $ t $ test and using the randomization inference (<em>Randomization Inference</em>). Remember that these tests are for the sharp null hypothesis of no effect for all units.</p>
<p>##<em>t</em>-test</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># a. t-test</span>

<span class="co"># H0: Average (# of days for treaties) - Mean (# of days for</span>
<span class="co"># control) = 0</span>

<span class="co"># We create a vector with the treated individuals:</span>
treated &lt;-<span class="st"> </span>data<span class="op">$</span>complete.obs[data<span class="op">$</span>complete.ra <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]
treated</code></pre>
<pre><code>##   [1] 24 15  8  9 15  5  8  9  9 21  6 23 11 20 12 12 19 18 17 10 17 12 14
##  [24]  5  6  0  0 16  7 16  8  3 33 19 29 23  9  9 14 22  9  9 37 16  7 19
##  [47] 14  7 12 19 23 16 11 15 12 27 47 19 29  8  8 34 22  6 37  5  4  2 13
##  [70]  8  8  7  6 12 23 21 18 14 16  8 18  0  2  0  4 16  3  3  5 23  9 23
##  [93] 17  9  8 26 17 15  2 15 14  3 50  7 11  0  6 11 11 22 13 44 28  8  9
## [116]  0 10 10  5  5  8  9 27  4  0  1  7  6 14 13  9 87 10  5  2  8 11 23
## [139]  0  2 13 21  5  0 14  4  6  4  3 16 10  6  7  8 29 11  7  7  9 12 59
## [162] 17  9 24 11 11 10 33  8  9 12 13 17 10 33 23 16 15 13 15 12 19  4  7
## [185]  2  2  3  1 16  2  0  9 17  5  6  5 14  6 13 12</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And then we calculate their variance</span>
var1 &lt;-<span class="st"> </span><span class="kw">sum</span>((treated <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(treated))<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span>(<span class="kw">length</span>(treated) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
var1</code></pre>
<pre><code>## [1] 119.1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And then the same for the control group:</span>
not_treated &lt;-<span class="st"> </span>data<span class="op">$</span>complete.obs[data<span class="op">$</span>complete.ra <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]
not_treated</code></pre>
<pre><code>##   [1]  17  16  56  35  16  23  17  30  13  17  34  13  15  14  25  20  17
##  [18]  22  15  46  16  35  18  34  37  18  19  31  19  20  18  25  34  17
##  [35]  32  33  18  10  29  10  19  10  11  13   7  13  39  11  17  16  25
##  [52]  25  11  11  10  32  24  20  14  13  31   7   8  13   7  31  22  24
##  [69]  36  17   9   7  20  16  10  12  15  76  14  12  15  43  33  18  14
##  [86]  16  28  57  37  13  24  39  21  13  30  14  16  17  15  12  28  18
## [103]  39  24  26  28  17  27  21  12  19  14  21  19  16  42  20  13  34
## [120]  28  14   8  11  13  11  11  11  27  11  13  10  15  19  11  25  23
## [137]  15  10  44   7   9  29   8  12  12   8   8  42   8  10  12  23  21
## [154]   7   9  11  16  14  23  11  10  34   7  19  10   9  16  29  12   7
## [171]   9  24   8  16  13  13   7  35  22   9  31  11   8   8   8   8  22
## [188]   8  13  32  20  24  10   7  10  16  45  31   8  10  25  12  11  25
## [205]   7  16  29  18  39  14  17  28   9   7  14   8  12  10  19   7  17
## [222]  48   9   9   8   7  29  20  12  11  22  10  17  53  50  16  11  47
## [239]  37   8   7   8  13  35   7  21  16  15  21  23   9  12  14   7  23
## [256]  17  19  18  12  10   9  11   8  20   7   8  29  24  17  12  21  14
## [273]  33  32  12   8  29  20  20  56  22  16  21  20   8   7  15  10  12
## [290]  12  18   8   7   7  20   7   7  24  30  37  11  12  26  26   9  21
## [307]  29  15  49  17  17   8  27  12  32  31  10  13   9  16  13  12  16
## [324]  53  25  29  18  21  15  51  14  16  27  14  20  15  39  21  14  13
## [341]  19  13  32  16  17  15  20  18  14  40  21  17  29  21  13  13  21
## [358]  31  28  16  10  12  15  24  15  13   9  22  52  10   8  11   8  12
## [375]  14  39   9 112  15  29   7  13  20  30   7  22  10  10  26  33   7
## [392]  25  13  17  27  16  11   9  17  11</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">var0 &lt;-<span class="st"> </span><span class="kw">sum</span>((not_treated <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(not_treated))<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span>(<span class="kw">length</span>(not_treated) <span class="op">-</span><span class="st"> </span>
<span class="st">  </span><span class="dv">1</span>)
var0</code></pre>
<pre><code>## [1] 137.4</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># already with this information we can calculate the error</span>
<span class="co"># est. of the difference</span>

estimated_se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(var1<span class="op">/</span><span class="kw">length</span>(treated) <span class="op">+</span><span class="st"> </span>var0<span class="op">/</span><span class="kw">length</span>(not_treated))
estimated_se</code></pre>
<pre><code>## [1] 0.9691</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We estimate our statistic t converting everything to</span>
<span class="co"># standard units:</span>
t_stat &lt;-<span class="st"> </span>((av.treat <span class="op">-</span><span class="st"> </span>av.control) <span class="op">-</span><span class="st"> </span><span class="dv">0</span>)<span class="op">/</span>estimated_se
t_stat</code></pre>
<pre><code>## [1] -6.318</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># In order to use the correct Student t distribution, we need</span>
<span class="co"># calculate degrees of freedom</span>
df &lt;-<span class="st"> </span>(var1<span class="op">/</span><span class="kw">length</span>(treated) <span class="op">+</span><span class="st"> </span>var0<span class="op">/</span><span class="kw">length</span>(not_treated))<span class="op">^</span><span class="dv">2</span><span class="op">/</span>((var1<span class="op">/</span><span class="kw">length</span>(treated))<span class="op">^</span><span class="dv">2</span><span class="op">/</span>(<span class="kw">length</span>(treated) <span class="op">-</span><span class="st"> </span>
<span class="st">  </span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>(var0<span class="op">/</span><span class="kw">length</span>(not_treated))<span class="op">^</span><span class="dv">2</span><span class="op">/</span>(<span class="kw">length</span>(not_treated) <span class="op">-</span><span class="st"> </span>
<span class="st">  </span><span class="dv">1</span>))
df</code></pre>
<pre><code>## [1] 424.3</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Where does our t statistic fall with respect to the t</span>
<span class="co"># distribution?  Install ggplot2 if you still do not have it.</span>
<span class="co"># A very useful package for graphics</span>
<span class="co"># install.packages(&#39;ggplot2&#39;)</span>

<span class="kw">library</span>(ggplot2)

<span class="co"># Generate a sequence of different values of x</span>
x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">len =</span> <span class="dv">100</span>)
<span class="co"># Empty element for the diagrma</span>
p &lt;-<span class="st"> </span><span class="kw">qplot</span>(x, <span class="dt">geom =</span> <span class="st">&quot;blank&quot;</span>)
<span class="co"># Graph the Student distribution with the parameters that we</span>
<span class="co"># have just estimated: i) df = degrees of freedom (df) ii)</span>
<span class="co"># ncp = non-centrality parameter. We want it to be 0.</span>
stat &lt;-<span class="st"> </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> dt, <span class="dt">args =</span> <span class="kw">list</span>(<span class="dt">df =</span> df, <span class="dt">ncp =</span> <span class="dv">0</span>), 
  <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>)
<span class="co"># We add this distribution to the empty chart and the</span>
<span class="co"># estimated difference in means:</span>
p <span class="op">+</span><span class="st"> </span>stat <span class="op">+</span><span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> t_stat, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</code></pre>
<p><img src="r-exercise-hypothesistesting_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now, we want the p-value. For this, we use the CDF of the</span>
<span class="co"># distribution pt to better understand what we are doing</span>

<span class="co"># Now, we want a test of one or two tails?</span>

<span class="co"># A p-value of a queue: the distribution is centered on 0 and</span>
<span class="co"># t_stat &lt;0.  This means that we are looking for the</span>
<span class="co"># probability that we will see a t-stat at least as SMALL (in</span>
<span class="co"># our case) as this one (bottom queue).</span>

<span class="co"># P-value of two tails: here we would need the same number</span>
<span class="co"># plus the probability that we see a t-stat greater than or</span>
<span class="co"># equal to:</span>
<span class="op">-</span>t_stat</code></pre>
<pre><code>## [1] 6.318</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First, let&#39;s look at the probability of observing a t</span>
<span class="co"># statistic as small as the one we observe:</span>
<span class="kw">pt</span>(t_stat, <span class="dt">df =</span> df, <span class="dt">ncp =</span> <span class="dv">0</span>, <span class="dt">lower.tail =</span> <span class="ot">TRUE</span>)</code></pre>
<pre><code>## [1] 3.355e-10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now, we need that probability plus the prob. of the upper</span>
<span class="co"># tail. We can do this with a single line of code:</span>
<span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pt</span>(<span class="kw">abs</span>(t_stat), df, <span class="dt">lower.tail =</span> F)</code></pre>
<pre><code>## [1] 6.711e-10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can also do this using the built-in R function (as in</span>
<span class="co"># Dan&#39;s slide this morning) which is called t.test:</span>
<span class="kw">t.test</span>(treated, not_treated, <span class="dt">alternative =</span> <span class="st">&quot;less&quot;</span>)  <span class="co"># a queue</span></code></pre>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  treated and not_treated
## t = -6.3, df = 424, p-value = 3e-10
## alternative hypothesis: true difference in means is less than 0
## 95 percent confidence interval:
##    -Inf -4.525
## sample estimates:
## mean of x mean of y 
##     12.97     19.09</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t.test</span>(treated, not_treated, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>)  <span class="co"># two tails</span></code></pre>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  treated and not_treated
## t = -6.3, df = 424, p-value = 7e-10
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -8.027 -4.218
## sample estimates:
## mean of x mean of y 
##     12.97     19.09</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Another way: We can also estimate this using a regression,</span>
<span class="co"># but we have to correct our standard errors to have in</span>
<span class="co"># account for the possibility of different variances between</span>
<span class="co"># treatment and control groups.</span>

(<span class="kw">lm_robust</span>(complete.obs <span class="op">~</span><span class="st"> </span>complete.ra, <span class="dt">data =</span> data))</code></pre>
<pre><code>##             Estimate Std. Error t value   Pr(&gt;|t|) CI Lower CI Upper  DF
## (Intercept)   19.093     0.5860  32.579 1.202e-134   17.942   20.243 598
## complete.ra   -6.123     0.9691  -6.318  5.182e-10   -8.026   -4.219 598</code></pre>
<p>##Randomization Inference</p>
<p>Recall that the sharp null hypothesis (a.k.a., * Sharp Null *) in RI is:
<span class="math display">\[ H_0: y_i (1) - y_i (0) = 0 \]</span>
for ALL units.</p>
<p>The ‘sharp null’ allows us to “observe” all the potential results for all the people (<strong>under the null hypothesis</strong>). Then, we can generate a distribution of all the different differences of estimated means that we would observe when replicating the multiple experiment times if the null one were known.</p>
<p>In general there are two ways to do this.
1. We produce a matrix with all possible treatment allocation vectors by permuting the total number of observations treated and the number of observations (complete randomization).
2. If the actual number of permutations is very large, we can instead replicate the treatment allocation, many times (eg, 10,000 times)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">choose</span>(<span class="dv">10</span>, <span class="dv">6</span>)</code></pre>
<pre><code>## [1] 210</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">choose</span>(<span class="dv">50</span>, <span class="dv">25</span>)</code></pre>
<pre><code>## [1] 1.264e+14</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Since the true permutation matrix in our example is very</span>
<span class="co"># large,</span>
<span class="kw">choose</span>(<span class="dv">600</span>, <span class="dv">400</span>)</code></pre>
<pre><code>## [1] 2.506e+164</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># we use method 2): We replicate the allocation (RANDOMLY) of</span>
<span class="co"># the treatment 10,000 times and we only keep the unique</span>
<span class="co"># vectors (because they can be repeated):</span>
perm_matrix &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dv">10000</span>, <span class="dv">600</span>)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10000</span>) {
  perm_matrix[i, ] &lt;-<span class="st"> </span><span class="kw">sample</span>(data<span class="op">$</span>complete.ra, <span class="dv">600</span>, <span class="dt">replace =</span> F)
}
perm_matrix &lt;-<span class="st"> </span><span class="kw">unique</span>(perm_matrix)

<span class="co"># Notice that each row is an experiment</span>
<span class="kw">dim</span>(perm_matrix)</code></pre>
<pre><code>## [1] 10000   600</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now we estimate the difference of means for each possible</span>
<span class="co"># randomization</span>

<span class="co"># We can use a loop for this:</span>
rand_ate &lt;-<span class="st"> </span><span class="ot">NA</span>  <span class="co"># Vector empty to go including the results</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(perm_matrix)) {
  <span class="co"># for each of the &#39;false&#39; treatment vectors</span>
  
  mean_treat &lt;-<span class="st"> </span><span class="kw">mean</span>(data<span class="op">$</span>complete.obs[perm_matrix[i, ] <span class="op">==</span><span class="st"> </span>
<span class="st">    </span><span class="dv">1</span>])
  
  mean_control &lt;-<span class="st"> </span><span class="kw">mean</span>(data<span class="op">$</span>complete.obs[perm_matrix[i, ] <span class="op">==</span><span class="st"> </span>
<span class="st">    </span><span class="dv">0</span>])
  
  <span class="co"># we calculate the difference of means for this randomization</span>
  rand_ate[i] &lt;-<span class="st"> </span>mean_treat <span class="op">-</span><span class="st"> </span>mean_control
  
}

<span class="kw">summary</span>(rand_ate)  <span class="co"># difference permutations vector</span></code></pre>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  -3.820  -0.715  -0.032  -0.015   0.665   3.830</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can make a graph to see the results better:</span>

<span class="kw">hist</span>(rand_ate, <span class="dt">breaks =</span> <span class="dv">100</span>, <span class="dt">main =</span> <span class="st">&quot;Permutation distribution&quot;</span>, 
  <span class="dt">xlab =</span> <span class="st">&quot;Value of the test statistic (doms)&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Freq.&quot;</span>, 
  <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>))
<span class="kw">abline</span>(<span class="dt">v =</span> diff.mean, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;slateblue&quot;</span>)</code></pre>
<p><img src="r-exercise-hypothesistesting_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How do we calculate the p-values in this context?</span>

<span class="co"># A tail</span>
<span class="kw">sum</span>(rand_ate <span class="op">&lt;=</span><span class="st"> </span>diff.mean)<span class="op">/</span><span class="kw">length</span>(rand_ate)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Two tails</span>
<span class="kw">sum</span>(<span class="kw">abs</span>(rand_ate) <span class="op">&lt;=</span><span class="st"> </span>diff.mean)<span class="op">/</span><span class="kw">length</span>(rand_ate)</code></pre>
<pre><code>## [1] 0</code></pre>
<p>##Main Points to Remember About Hypothesis Testing</p>
<ol style="list-style-type: decimal">
<li>Hypothesis testing is a calculation of the probability that we can reject stated hypotheses about our treatment effect. This provides us with a means of characterizing our certainty that an estimated treatment effect approximates the true treatment effect.</li>
<li>The most common hypothesis that we test is the sharp null hypothesis, which states that the treatment had absolutely no effect on any individual unit. To test this hypothesis, we calculate the probability that we could have observed the treatment effect we did if the treatment in reality had no effect whatsoever. This probability is known as a p-value. For example, a p-value of .05 is interpreted as a 5% chance that we could observe a treatment effect at least as large as the one we found if the treatment in fact had no effect.</li>
<li>It is conventional that p-values of .05 or lower are “significant”. This is an arbitrary cutoff, but it is so widely used in statistics that any study that fails to recover a p-value of less than .1 will report that the treatment effect is null. Nonetheless, also make sure to interpret the substance and magnitude of the treatment effect, and avoid focusing solely on statistical significance.</li>
<li>Type I error is when you reject the null hypothesis when it is actually true. In other words, you conclude that the treatment did have an effect, when in reality, it did not. The significance level can also be interpreted as the probability that we are committing Type I error. (Type II error is when you accept the null hypothesis when it is actually false, in other words, you conclude a null effect when one actually existed.)</li>
<li>Randomization inference enables us to calculate what the observed treatment effect would have been in every possible randomization of the experiment if we hypothesize that no subject responded to the treatment (our null hypothesis). From this, we can calculate the probability that we would have observed our treatment effect if the true treatment effect was actually zero. If this is a very low probability, then we have more confidence in the significance of our findings from the single randomization we actually observed.</li>
</ol>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/egap/learningdays-guide/edit/master/Guide/%s",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
},
"search": false
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
